<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chemistry Board Game – George's Pain and Suffering</title>
<style>
  :root{ --ink:#111; --good:#2ecc71; --bad:#e74c3c; --panel:#ffffffcc; }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:#ede7e3; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:flex; flex-direction:column; align-items:center; padding:18px; padding-bottom:120px;
  }

  /* Board */
  .board-wrap{
    position:relative; width:min(1200px,95vw); aspect-ratio:16/9; background:#f7f4f1;
    border-radius:16px; overflow:hidden; box-shadow:0 12px 40px #00000022; margin-bottom:92px;
  }
  .board-bg{ position:absolute; inset:0; background:url('board.png') center/contain no-repeat; z-index:1; }

  /* Tokens */
  .token{
    position:absolute; width:26px; height:26px; border-radius:50%; border:2px solid #000;
    transform:translate(-50%,-50%); transition:left .28s ease, top .28s ease;
    z-index:5; box-shadow:0 2px 5px #00000040;
  }
  .p1{ background:#ff5d5d } .p2{ background:#5d9bff } .p3{ background:#50d890 }
  .p4{ background:#ffd166 } .p5{ background:#b07aff }

  /* Center Dice */
  .dice{
    position:absolute; inset:0; margin:auto; width:min(18vmin,140px); height:min(18vmin,140px);
    background:#cc6b6b; border-radius:22px; box-shadow:inset 0 -8px 0 #00000025, 0 10px 25px #00000025;
    display:grid; place-items:center; cursor:pointer; user-select:none; z-index:6;
    transition:transform .1s ease; 
  }
  .dice:active{ transform:scale(.98) }
  .pips{
    width:70%; height:70%; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:6%;
  }
  .pip{ display:flex; align-items:center; justify-content:center; }
  .pip::before{ content:""; width:18px; height:18px; border-radius:50%; background:#fff; }
  .hidden{ visibility:hidden }
  .roll-hint{ position:absolute; left:50%; top:56%; transform:translateX(-50%); font-size:14px; background:#ffffffcc; padding:4px 10px; border-radius:999px; z-index:6 }

  /* HUD */
  .hud{ display:flex; flex-wrap:wrap; justify-content:center; gap:12px; }
  .panel{ background:var(--panel); backdrop-filter:blur(4px); border:1px solid #00000018; border-radius:12px; padding:10px 14px; box-shadow:0 8px 24px #00000020 }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .btn{ border:0; border-radius:10px; padding:8px 14px; font-weight:700; cursor:pointer; background:#111; color:#fff }
  .btn.alt{ background:#fff; color:#111; border:2px solid #00000022 }
  .chip{ border-radius:999px; padding:4px 10px; background:#00000010; font-weight:700 }
  .chip.dark{ background:#111; color:#fff }

  /* Modal */
  .modal{ position:fixed; inset:0; background:#00000066; display:none; align-items:center; justify-content:center; z-index:50; padding:18px }
  .modal.show{ display:flex }
  .dialog{ background:#fff; width:min(760px,95vw); border-radius:16px; border:2px solid #00000020; padding:18px }
  .dialog h2{ margin:0 0 8px }
  .options{ display:grid; gap:10px; margin-top:10px }
  .optBtn{ border:2px solid #00000020; border-radius:12px; background:#fff; padding:12px; text-align:left; font-weight:700; cursor:pointer }
  .optBtn:hover{ border-color:#00000045 }
  .banner{ padding:10px 12px; border-radius:12px; color:#fff; font-weight:800 }
  .good{ background:var(--good) } .bad{ background:var(--bad) }
</style>
</head>
<body>

<div class="board-wrap" id="board">
  <div class="board-bg" aria-hidden="true"></div>

  <!-- Center Dice -->
  <div id="dice" class="dice" title="Roll">
    <div class="pips" id="pips">
      <div class="pip" data-pos="1"></div>
      <div class="pip" data-pos="2"></div>
      <div class="pip" data-pos="3"></div>
      <div class="pip" data-pos="4"></div>
      <div class="pip" data-pos="5"></div>
      <div class="pip" data-pos="6"></div>
      <div class="pip" data-pos="7"></div>
      <div class="pip" data-pos="8"></div>
      <div class="pip" data-pos="9"></div>
    </div>
  </div>
  <div class="roll-hint" id="rollHint">Tap the dice to roll</div>

  <!-- Tokens -->
  <div id="t1" class="token p1"></div>
  <div id="t2" class="token p2"></div>
  <div id="t3" class="token p3"></div>
  <div id="t4" class="token p4"></div>
  <div id="t5" class="token p5"></div>
</div>

<!-- HUD -->
<div class="hud">
  <div class="panel">
    <div class="row">
      <b>Players:</b>
      <select id="playerCount" class="btn alt" style="padding:6px 10px">
        <option>2</option><option>3</option><option>4</option><option selected>5</option>
      </select>
      <button id="apply" class="btn">Apply</button>
      <button id="reset" class="btn alt">Restart</button>
    </div>
  </div>
  <div class="panel">
    <div class="row">
      <span class="chip dark" id="turnChip">Turn: –</span>
      <span class="chip" id="rollChip">Roll to start</span>
    </div>
    <div id="scores" class="row" style="margin-top:8px"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="dialog"><div id="modalContent"></div></div></div>

<script>
/* 
  BOARD LAYOUT
   Path order (24 total tiles):
   0 START (bottom-left) ->
   1..4 go UP the left side (4 spaces) ->
   5..12 go RIGHT across the top (8 spaces) ->
   13..16 go DOWN right side (4 spaces) ->
   17..23 go LEFT across the bottom (7 spaces) ->
   23 is FINISH.
*/
function buildPath(){
  const P=[];
  // 0: start near bottom-left
  P.push({x:16, y:92});                     // 0 START
  // Up 4
  P.push({x:16, y:78});                     // 1
  P.push({x:16, y:64});                     // 2
  P.push({x:16, y:50});                     // 3
  P.push({x:16, y:24});                     // 4
  // Right across top (8) at y=10
  P.push({x:16, y:24});                     // 5
  P.push({x:24, y:24});                     // 6
  P.push({x:34, y:24);                     // 7
  P.push({x:44, y:24});                     // 8
  P.push({x:54, y:24});                     // 9
  P.push({x:64, y:24});                     //10
  P.push({x:74, y:24});                     //11
  P.push({x:84, y:24});                     //12
  // Down right side (4)
  P.push({x:92, y:26});                     //13
  P.push({x:92, y:42});                     //14
  P.push({x:92, y:58});                     //15
  P.push({x:92, y:74});                     //16
  // Left bottom (7) at y=92
  P.push({x:82, y:92});                     //17
  P.push({x:72, y:92});                     //18
  P.push({x:62, y:92});                     //19
  P.push({x:52, y:92});                     //20
  P.push({x:42, y:92});                     //21
  P.push({x:32, y:92});                     //22
  P.push({x:24, y:92});                     //23 FINISH
  return P;
}
const PATH = buildPath();
const START_INDEX = 0;
const FINISH_INDEX = PATH.length-1; // 23

/* Tile types along the loop:
   Q = question (random from bank)
   E = event (random from bank)
   . = neutral
*/
const TILE_TYPES = [
  'S', 'E','Q','E','.',  // 0..4  (up)
  'Q','E','Q','E','Q','E','Q','E',  // 5..12 (top)
  'Q','E','Q','E',      // 13..16 (down)
  'E','Q','E','Q','E','Q','F' // 17..23 (bottom to finish)
];

/*
   QUESTION BANK
*/
const QUESTIONS_BASE = [
  // Families & general
  {q:"Which group contains the alkali metals?", c:["Group 1","Group 2","Group 17","Group 18"], a:"A"},
  {q:"Which group contains the alkaline earth metals?", c:["1","2","16","17"], a:"B"},
  {q:"Which group contains the halogens?", c:["15","16","17","18"], a:"C"},
  {q:"Which group contains the noble gases?", c:["16","17","18","1"], a:"C"},
  // Trends (AR, IE, EN, metallic)
  {q:"Across a period, atomic radius generally…", c:["increases","decreases","stays the same","doubles"], a:"B"},
  {q:"Down a group, atomic radius generally…", c:["increases","decreases","stays the same","is unpredictable"], a:"A"},
  {q:"Across a period, ionization energy generally…", c:["decreases","increases","stays same","depends on mass"], a:"B"},
  {q:"Down a group, ionization energy generally…", c:["increases","decreases","no trend","oscillates"], a:"B"},
  {q:"Across a period, electronegativity generally…", c:["decreases","increases","random","no trend"], a:"B"},
  {q:"Down a group, electronegativity generally…", c:["increases","decreases","random","no trend"], a:"B"},
  {q:"Metallic character increases when moving…", c:["across a period (→)","up a group","down a group","toward the noble gases"], a:"C"},
  // Element facts 
  {q:"Atomic number of Hydrogen (H)?", c:["1","2","3","4"], a:"A"},
  {q:"Atomic number of Helium (He)?", c:["8","10","2","18"], a:"C"},
  {q:"Atomic number of Lithium (Li)?", c:["3","11","19","12"], a:"A"},
  {q:"Sodium’s symbol is…", c:["S","Na","So","Sd"], a:"B"},
  {q:"Potassium’s symbol is…", c:["P","Po","K","Pt"], a:"C"},
  {q:"Calcium’s symbol is…", c:["Ca","Cl","Cs","C"], a:"A"},
  {q:"Magnesium’s symbol is…", c:["Mn","Mg","Ma","M"], a:"B"},
  {q:"Aluminum is in which group?", c:["1","13","16","18"], a:"B"},
  {q:"Carbon makes how many common covalent bonds?", c:["1","2","3","4"], a:"D"},
  {q:"Nitrogen’s symbol is…", c:["Ni","Na","N","Nt"], a:"C"},
  {q:"Oxygen’s group is best described as…", c:["alkali metal","noble gas","halogen","chalcogen"], a:"D"},
  {q:"Fluorine is highly…", c:["metallic","electronegative","noble","radioactive only"], a:"B"},
  {q:"Neon is…", c:["a halogen","a noble gas","an alkali metal","a metalloid"], a:"B"},
  {q:"Silicon (Si) is classified as a…", c:["metal","nonmetal","metalloid","noble gas"], a:"C"},
  {q:"Phosphorus commonly forms how many covalent bonds?", c:["3","5","4","1"], a:"C"},
  {q:"Chlorine belongs to which family?", c:["noble gases","alkaline earth metals","halogens","actinides"], a:"C"},
  {q:"Argon is mostly…", c:["reactive","inert","explosive","radioactive"], a:"B"},
  {q:"Iron’s symbol is…", c:["Ir","Fe","In","Fr"], a:"B"},
  {q:"Copper’s symbol is…", c:["Co","Cu","Cr","Cp"], a:"B"},
  {q:"Zinc’s symbol is…", c:["Z","Zn","Zi","Zc"], a:"B"},
  {q:"Bromine (Br) at room temperature is…", c:["solid","liquid","gas","plasma"], a:"B"},
  {q:"Iodine (I) belongs to…", c:["halogens","alkali metals","noble gases","alkaline earth metals"], a:"A"},
  {q:"Cesium (Cs) is a very reactive…", c:["alkali metal","noble gas","halogen","metalloid"], a:"A"},
  {q:"Barium (Ba) belongs to…", c:["alkaline earth metals","halogens","lanthanides","noble gases"], a:"A"},
  {q:"Gold’s symbol is…", c:["Ag","Au","Gd","Go"], a:"B"},
  {q:"Mercury (Hg) at room temperature is a…", c:["solid metal","liquid metal","gas","nonmetal"], a:"B"},
  {q:"Lead’s symbol is…", c:["Ld","Pb","Pl","Le"], a:"B"},
  {q:"Uranium’s symbol is…", c:["Ur","U","Un","Um"], a:"B"},
  // bonding & compounds / periodic logic
  {q:"Which pair will most likely form an ionic compound?", c:["Na & Cl","C & O","H & H","N & O"], a:"A"},
  {q:"Which element has the highest EN in its period?", c:["Na","Al","Si","Cl"], a:"D"},
  {q:"Which element is more metallic?", c:["Mg or Cl?","C or Na?","F or Li?","Si or Al?"], a:"B"}, // interpret as “C or Na?” -> Na
  {q:"Which atom is largest in radius?", c:["Li","C","F","Ne"], a:"A"},
  {q:"Which atom is smallest in radius?", c:["K","Ca","Ar","Cl"], a:"D"},
  {q:"Which has the highest first ionization energy?", c:["Mg","Al","Si","P"], a:"D"},
  {q:"Noble gases are mostly unreactive because…", c:["full valence shell","low mass","invisible","liquids"], a:"A"},
  {q:"Which element is a halogen with atomic number 17?", c:["F","Cl","Br","I"], a:"B"},
  {q:"Which is a metalloid?", c:["B","O","Ca","Kr"], a:"A"},
  {q:"Which element commonly forms +2 ions?", c:["Mg","Al","Na","Cl"], a:"A"},
  {q:"Which has the lowest electronegativity?", c:["Cs","H","O","F"], a:"A"},
  {q:"Which is NOT a transition metal?", c:["Fe","Cu","Zn","Si"], a:"D"},
  {q:"Which pair will most likely form a covalent bond?", c:["K & Br","Na & Cl","C & H","Mg & O"], a:"C"},
  {q:"Which element is in Period 3, Group 16?", c:["S","Se","O","Te"], a:"A"},
  {q:"Which element has the configuration [Ne]3s¹?", c:["Na","Mg","Al","Si"], a:"A"},
];
// enrich scoring effects per question (all visible)
const QUESTIONS_BANK = QUESTIONS_BASE.map(q=>({
  ...q,
  ptsCorrect: 2,
  ptsWrong: -1,
  moveBackOnWrong: 1
}));

/* 
    EVENT CARD BANK (reactions/compounds; positives & negatives)
   - Each event has text and any of: points, move, skip (+ adds, − removes)
 */
const EVENTS_BANK = [
  {text:"Sodium reacts violently with water! Lose 2 points.", points:-2},
  {text:"Helium is super stable — collect 3 points.", points:+3},
  {text:"Fluorine steals an electron — move another player back 1 (choose).", chooseTargetBack:1},
  {text:"Catalyst speeds reaction — move ahead 2 spaces.", move:+2},
  {text:"Precipitation reaction succeeds — +2 points.", points:+2},
  {text:"Endothermic step absorbs heat — lose 1 point.", points:-1},
  {text:"Redox bonus: Cu²⁺ reduced to Cu — +3 points.", points:+3},
  {text:"Corrosion setback: Fe → Fe²⁺ — move back 1.", move:-1},
  {text:"Lab accident: spill! Skip next turn.", skip:+1},
  {text:"Noble gas detour: you do nothing. (Stable!)"},
  {text:"Combustion complete — CO₂ + H₂O formed. Move ahead 1.", move:+1},
  {text:"Le Châtelier pushback — system shifts left. Move back 2.", move:-2},
  {text:"Ionic lattice formed (NaCl) — +2 points.", points:+2},
  {text:"Electronegativity win — take 1 point from a player (choose).", steal:1},
  {text:"Alloy crafted (brass) — +1 point and move ahead 1.", points:+1, move:+1},
  {text:"Acid–base neutralization — +2 points.", points:+2},
  {text:"Gas escapes! Lose a point.", points:-1},
  {text:"Jail time (safety review) — lose next turn.", skip:+1},
  {text:"Peer review success — remove 1 skip if you have any.", skip:-1},
  {text:"Photon boost — +1 point; photoelectric kick you forward 1.", points:+1, move:+1},
];

/* 
    GAME STATE & UI
*/
const NAMES_DEFAULT = ["George","Angie","Kobe","Walter","Alexander"];

const boardEl = document.getElementById('board');
const diceEl  = document.getElementById('dice');
const pipsEl  = document.getElementById('pips');
const rollHint= document.getElementById('rollHint');
const scoresRow = document.getElementById('scores');
const turnChip  = document.getElementById('turnChip');
const rollChip  = document.getElementById('rollChip');
document.getElementById('apply').onclick = ()=> boot(Number(document.getElementById('playerCount').value||5));
document.getElementById('reset').onclick = ()=> boot(Number(document.getElementById('playerCount').value||5));

let players = [];  
let current = 0;
let locked  = false;
let Q_STACK = [];
let E_STACK = [];

function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function refillStacks(){
  if(Q_STACK.length===0) Q_STACK = shuffle(QUESTIONS_BANK);
  if(E_STACK.length===0) E_STACK = shuffle(EVENTS_BANK);
}

function boot(n=5){
  refillStacks();
  players = Array.from({length:n}, (_,i)=>({
    name: NAMES_DEFAULT[i] || `Player ${i+1}`,
    pos: START_INDEX, score: 0, skip: 0, done: false,
    token: document.getElementById('t'+(i+1))
  }));
  for(let i=0;i<5;i++){
    const t = document.getElementById('t'+(i+1));
    t.style.display = i<n ? 'block' : 'none';
  }
  players.forEach((p,i)=> placeToken(p, START_INDEX, startNudge(i)) );
  renderScores(); current = 0; updateTurn(); rollChip.textContent = 'Roll to start';
  locked=false; rollHint.style.display='';
  showPips(1);
}

function startNudge(i){ // spread 
  return [{dx:-10,dy:-8},{dx:+10,dy:-8},{dx:-10,dy:+8},{dx:+10,dy:+8},{dx:0,dy:0}][i%5];
}
function tokenNudge(i){ // small spread
  return [{dx:-6,dy:-6},{dx:+6,dy:-6},{dx:+6,dy:+6},{dx:-6,dy:+6},{dx:0,dy:0}][i%5];
}
function placeToken(player, idx, nudge={dx:0,dy:0}){
  const {x,y} = PATH[idx];
  player.token.style.left = `${x}%`;
  player.token.style.top  = `${y}%`;
  player.token.style.transform = `translate(-50%,-50%) translate(${nudge.dx}px,${nudge.dy}px)`;
}

function renderScores(){
  scoresRow.innerHTML = '';
  players.forEach((p,i)=>{
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.id = `chip${i}`;
    chip.innerHTML = `<b>${p.name}</b>: <span id="sc${i}">${p.score}</span> pts · Space <span id="sp${i}">${p.pos}</span>${p.done?' · ✅ Finished':''}`;
    scoresRow.appendChild(chip);
  });
}
function updateTurn(){ turnChip.textContent = `Turn: ${players[current].name}`; }

/* Dice pips */
const pipsMap = {1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,3,4,6,7,9]};
function showPips(n){
  const cells = pipsEl.querySelectorAll('.pip');
  cells.forEach(c=>c.classList.add('hidden'));
  (pipsMap[n]||[]).forEach(pos=>{
    const el = pipsEl.querySelector(`.pip[data-pos="${pos}"]`);
    if(el) el.classList.remove('hidden');
  });
}

/* Rolling / movement */
diceEl.addEventListener('click', ()=>{
  if (locked) return;
  if (players.filter(p=>!p.done).length===0) return; // all finished
  if (players[current].done) { nextTurn(); return; }

  const p = players[current];
  if (p.skip>0){ p.skip--; toast(`${p.name} skips this turn.`); nextTurn(); return; }

  locked = true; rollHint.style.display='none';

  const roll = Math.floor(Math.random()*6)+1;
  showPips(roll);
  rollChip.textContent = `Rolled ${roll}`;

  let steps = roll;
const step = () => {
  if (steps <= 0) { landed(); return; }

  p.pos = Math.min(p.pos + 1, FINISH_INDEX);
  document.getElementById('sp' + current).textContent = p.pos;
  placeToken(p, p.pos, tokenNudge(current));
  steps--;

  if (steps === 0 || p.pos === FINISH_INDEX) {
    setTimeout(landed, 250);  // small delay for visual stop
  } else {
    setTimeout(step, 250);
  }
};
step();
});

function landed(){
  const p = players[current];
  const idx = p.pos;

  if (idx===FINISH_INDEX && !p.done){
    deltaScore(current, +3);
    p.done = true;
    document.getElementById('chip'+current).innerHTML =
      `<b>${p.name}</b>: <span id="sc${current}">${p.score}</span> pts · Space <span id="sp${current}">${p.pos}</span> · ✅ Finished`;
    toast(`🎉 ${p.name} reached FINISH! (+3 pts)`);
    locked=false;
    if (players.every(pp=>pp.done)){
      const max = Math.max(...players.map(pp=>pp.score));
      const winners = players.filter(pp=>pp.score===max).map(pp=>pp.name);
      openModal(`<h2>Game Over</h2>
        <div style="font-size:18px">Winner${winners.length>1?'s':''}: <b>${winners.join(', ')}</b> with <b>${max}</b> pts.</div>
        <div style="text-align:right;margin-top:12px"><button class="btn" id="ok">OK</button></div>`);
      modal.querySelector('#ok').addEventListener('click',()=>closeModal());
    }
    nextTurn(); 
    return;
  }

  const type = TILE_TYPES[idx];
  if(type==='Q'){ askRandomQuestion(); return; }
  if(type==='E'){ runRandomEvent(); return; }
  locked=false; nextTurn();
}

function deltaScore(i, n){
  players[i].score += n;
  document.getElementById('sc'+i).textContent = players[i].score;
}

function movePlayer(i, delta){
  const p=players[i];
  p.pos = Math.max(START_INDEX, Math.min(FINISH_INDEX, p.pos + delta));
  document.getElementById('sp'+i).textContent = p.pos;
  placeToken(p, p.pos, tokenNudge(i));
}

function nextTurn(){
  let tries=0;
  do{
    current = (current+1) % players.length;
    tries++;
    if (tries>players.length+2) break; // safety
  } while(players[current].done);
  updateTurn();
}

/* 
   QUESTIONS & EVENTS (modals)
*/
const modal=document.getElementById('modal');
const modalContent=document.getElementById('modalContent');
function openModal(html){ modalContent.innerHTML=html; modal.classList.add('show'); }
function closeModal(){ modal.classList.remove('show'); }
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

function toast(text){
  openModal(`<div class="banner" style="background:#111">${text}</div>
    <div style="text-align:right;margin-top:10px"><button class="btn" id="ok">OK</button></div>`);
  modal.querySelector('#ok').addEventListener('click',()=>closeModal());
}

function askRandomQuestion(){
  refillStacks();
  const tileQ = Q_STACK.pop(); // draw
  const letters=['A','B','C','D'];
  const opts = tileQ.c.map((t,idx)=>`<button class="optBtn" data-k="${letters[idx]}"><b>${letters[idx]}.</b> ${t}</button>`).join('');
  openModal(`<h2>Question</h2><div style="font-size:18px">${tileQ.q}</div><div class="options">${opts}</div>`);
  modal.querySelectorAll('.optBtn').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const k = e.currentTarget.getAttribute('data-k');
      if (k===tileQ.a){
        deltaScore(current, tileQ.ptsCorrect);
        openModal(`<div class="banner good">✅ Correct! +${tileQ.ptsCorrect} pts</div>
          <div style="text-align:right;margin-top:10px"><button class="btn" id="go">Continue</button></div>`);
        modal.querySelector('#go').addEventListener('click', ()=>{ closeModal(); locked=false; nextTurn(); });
      }else{
        deltaScore(current, tileQ.ptsWrong);
        if (tileQ.moveBackOnWrong) movePlayer(current, -tileQ.moveBackOnWrong);
        openModal(`<div class="banner bad">❌ Wrong. ${tileQ.ptsWrong} pt; moved back ${tileQ.moveBackOnWrong}.</div>
          <div style="text-align:right;margin-top:10px"><button class="btn" id="go">Continue</button></div>`);
        modal.querySelector('#go').addEventListener('click', ()=>{ closeModal(); locked=false; nextTurn(); });
      }
    });
  });
}

function chooseTarget(callback){
  const others = players.map((p,i)=>({p,i})).filter(o=>o.i!==current);
  const buttons = others.map(o=>`<button class="btn alt" data-i="${o.i}">${o.p.name}</button>`).join(' ');
  openModal(`<h2>Choose a player</h2><div class="row">${buttons}</div>`);
  modal.querySelectorAll('button[data-i]').forEach(b=>{
    b.addEventListener('click',()=>{ const i=Number(b.getAttribute('data-i')); closeModal(); callback(i); });
  });
}

function runRandomEvent(){
  refillStacks();
  const ev = E_STACK.pop();

  // events that require choosing target
  if (ev.chooseTargetBack){
    chooseTarget((i)=>{
      movePlayer(i, -ev.chooseTargetBack);
      openModal(`<div class="banner">Moved ${players[i].name} back ${ev.chooseTargetBack}.</div>
        <div style="text-align:right;margin-top:10px"><button class="btn" id="ok">OK</button></div>`);
      modal.querySelector('#ok').addEventListener('click',()=>{ closeModal(); locked=false; nextTurn(); });
    });
    return;
  }
  if (ev.steal){
    chooseTarget((i)=>{
      const s = Math.min(ev.steal, players[i].score);
      players[i].score -= s; document.getElementById('sc'+i).textContent = players[i].score;
      deltaScore(current, s);
      openModal(`<div class="banner">Stole ${s} point${s===1?'':'s'} from ${players[i].name}.</div>
        <div style="text-align:right;margin-top:10px"><button class="btn" id="ok">OK</button></div>`);
      modal.querySelector('#ok').addEventListener('click',()=>{ closeModal(); locked=false; nextTurn(); });
    });
    return;
  }

  // plain effects
  if (ev.points) deltaScore(current, ev.points);
  if (ev.move) movePlayer(current, ev.move);
  if (ev.skip) players[current].skip = Math.max(0, players[current].skip + ev.skip);

  openModal(`<h2>Event</h2><div style="font-size:18px">${ev.text || 'Event'}</div>
    <div style="text-align:right;margin-top:10px"><button class="btn" id="ok">Continue</button></div>`);
  modal.querySelector('#ok').addEventListener('click', ()=>{ closeModal(); locked=false; nextTurn(); });
}

/* Keep tokens aligned on resize */
window.addEventListener('resize', ()=> players.forEach((p,i)=> placeToken(p,p.pos, p.pos===START_INDEX?startNudge(i):tokenNudge(i)) ) );

/* Initialize */
boot(5);
</script>
</body>
</html>



